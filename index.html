<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webinar Config Page</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Quill Rich Text -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body {padding: 20px;}
    .pointer {cursor: pointer}
    .banner-preview {height: 200px; object-fit: cover; width: 100%; border-radius: 6px}
    .support-thumb {height: 90px; object-fit: cover}
    .stats-card {min-height: 100px}
    .events-table td, .events-table th {vertical-align: middle}
    .quill-editor {height: 150px}
    #summaryView {display:none}
    .time-select {width: 120px}
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex align-items-center mb-3">
    <h2 class="me-auto">Webinar Configuration</h2>
    <button id="btnAdd" class="btn btn-primary">+ Add Webinar</button>
  </div>

  <!-- Stats -->
  <div class="row g-3 mb-4" id="statsRow">
    <!-- populated by JS -->
  </div>

  <!-- Webinar Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="webinarTable">
          <thead>
            <tr>
              <th>Title</th>
              <th>Short Description</th>
              <th>Number of Events</th>
              <th>Active</th>
              <th>Number of Attainers</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="webinarModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Webinar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="webinarForm">
            <input type="hidden" id="editingId" value="">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Webinar title</label>
                <input class="form-control" id="title" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Short description</label>
                <input class="form-control" id="shortDesc">
              </div>

              <div class="col-12">
                <label class="form-label">Banner image</label>
                <input class="form-control" type="file" id="bannerImage" accept="image/*">
                <img id="bannerPreview" class="banner-preview mt-2 d-none">
              </div>

              <div class="col-12">
                <label class="form-label">Supporting images (multiple)</label>
                <input class="form-control" type="file" id="supportImages" accept="image/*" multiple>
                <div id="supportPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">YouTube intro video link</label>
                <input class="form-control" id="youtubeLink">
              </div>
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select id="category" class="form-select">
                  <option value="online">Online</option>
                  <option value="offline">Offline</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Primary host name</label>
                <input class="form-control" id="hostName">
              </div>
              <div class="col-md-6">
                <label class="form-label">Host email</label>
                <input class="form-control" id="hostEmail" type="email">
              </div>
              <div class="col-md-4">
                <label class="form-label">Country code</label>
                <select id="countryCode" class="form-select">
                  <option value="+91">+91</option>
                  <option value="+1">+1</option>
                  <option value="+44">+44</option>
                  <option value="+61">+61</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">Host phone</label>
                <input class="form-control" id="hostPhone">
              </div>

              <div class="col-12">
                <label class="form-label">Complete description</label>
                <div id="descEditor" class="quill-editor"></div>
              </div>

              <!-- Events editable table -->
              <div class="col-12 mt-3">
                <div class="d-flex align-items-center mb-2">
                  <h5 class="me-auto">Events</h5>
                  <button id="addEventRow" type="button" class="btn btn-sm btn-outline-secondary">+ Add event</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-bordered events-table" id="eventsTable">
                    <thead>
                      <tr>
                        <th>Event name</th>
                        <th>Short description</th>
                        <th>Complete description</th>
                        <th>Event date</th>
                        <th>Start time</th>
                        <th>End time</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Confirm Modal -->
  <div class="modal fade" id="confirmCancelModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">You will lose all info. Are you sure?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button id="confirmCancelYes" class="btn btn-danger" data-bs-dismiss="modal">Yes, discard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary View (single-page) -->
  <div id="summaryView" class="mt-4">
    <button id="backToList" class="btn btn-link">← Back to list</button>
    <div class="card mb-3">
      <div class="card-body">
        <div id="summaryBannerWrap"></div>
        <div class="mt-3 d-flex gap-3 align-items-start">
          <div style="flex:1">
            <div id="summaryTitle" class="h4"></div>
            <div id="summaryShort" class="text-muted"></div>
            <div class="mt-2">
              <button id="editFromSummary" class="btn btn-outline-primary btn-sm">Edit</button>
            </div>
          </div>
          <div style="width:400px">
            <div id="ytWrap"></div>
          </div>
        </div>

        <div class="mt-3" id="supportingCarouselWrap"></div>
        <div class="mt-3" id="summaryDesc"></div>
      </div>
    </div>

    <div class="row g-3" id="eventsCards"></div>
  </div>

</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
// Simple single-file demo implementation storing data in localStorage.
// Replace localStorage calls with AJAX calls to your backend (POST /api/webinars etc.)

const STORAGE_KEY = 'webinars_v1';
let quill;
let webinars = []; // array of webinar objects
let currentEditing = null;

function timeOptions() {
  const arr = [];
  const pad = n=> n<10? '0'+n: ''+n;
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=15){
      const hh = h%12===0?12:h%12;
      const am = h<12? 'AM':'PM';
      arr.push(`${hh}:${pad(m)} ${am}`);
    }
  }
  return arr;
}

function loadFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  webinars = raw? JSON.parse(raw): [];
}

function saveToStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(webinars));
}

function renderStats(){
  const container = $('#statsRow'); container.empty();
  const active = webinars.filter(w=> w.isActive).length;
  const inactive = webinars.filter(w=> !w.isActive);
  const weekCount = webinars.filter(w=> {
    if(!w.createdAt) return false;
    const diff = Date.now() - new Date(w.createdAt).getTime();
    return diff < 7*24*3600*1000;
  }).length;

  const cards = [
    {title: 'Active webinars', value: active, desc: 'Currently active webinars'},
    {title: 'Added this week', value: weekCount, desc: 'Added in last 7 days'},
    {title: 'Inactive webinars', value: inactive.length, desc: 'Click below to view inactive'},
  ];

  cards.forEach((c,i)=>{
    const el = $(
      `<div class="col-md-4">
        <div class="card stats-card p-3">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <h3 class="mb-0">${c.value}</h3>
            </div>
            <div>
              <div class="fw-bold">${c.title}</div>
              <div class="text-muted small">${c.desc}</div>
            </div>
          </div>
          ${i===2 ? `<div class="mt-2 small text-muted">${inactive.slice(0,3).map(x=> `<div><strong>${x.title}</strong> — ${x.shortDesc||''}</div>`).join('')}</div>`: ''}
        </div>
      </div>`
    );
    container.append(el);
  });
}

function renderTable(){
  const tbody = $('#webinarTable tbody'); tbody.empty();
  webinars.forEach((w, idx)=>{
    const tr = $(`<tr class="pointer" data-id="${w.id}">
      <td>${w.title}</td>
      <td>${w.shortDesc||''}</td>
      <td>${(w.events||[]).length}</td>
      <td>${w.isActive? 'Yes':'No'}</td>
      <td>${w.attainers||0}</td>
    </tr>`);
    tr.on('click', ()=> openSummary(w.id));
    tbody.append(tr);
  });
}

function resetModal(){
  $('#webinarForm')[0].reset();
  $('#bannerPreview').attr('src','').addClass('d-none');
  $('#supportPreview').empty();
  quill.setText('');
  $('#eventsTable tbody').empty();
  $('#editingId').val('');
  currentEditing = null;
}

function openAddModal(){
  resetModal();
  $('#modalTitle').text('Add Webinar');
  const modal = new bootstrap.Modal(document.getElementById('webinarModal'));
  modal.show();
}

function addEventRow(eventObj){
  const times = timeOptions();
  const tr = $('<tr>');
  const id = Date.now()+Math.random();
  tr.append(`<td><input class="form-control event-name" value="${eventObj?.name||''}"></td>`);
  tr.append(`<td><input class="form-control event-short" value="${eventObj?.short||''}"></td>`);
  const editorId = 'evdesc_'+id;
  tr.append(`<td><div class="ev-desc" data-id="${editorId}"></div></td>`);
  tr.append(`<td><input type="date" class="form-control event-date" value="${eventObj?.date||''}"></td>`);
  const startSel = $('<select class="form-select time-select start-time"></select>');
  const endSel = $('<select class="form-select time-select end-time"></select>');
  times.forEach(t=>{ startSel.append(`<option ${eventObj?.start===t? 'selected':''}>${t}</option>`); endSel.append(`<option ${eventObj?.end===t? 'selected':''}>${t}</option>`)});
  tr.append($('<td>').append(startSel));
  tr.append($('<td>').append(endSel));
  tr.append(`<td><button class="btn btn-sm btn-danger remove-event">Remove</button></td>`);

  $('#eventsTable tbody').append(tr);

  // initialize Quill for each event description cell (small)
  const editorDiv = tr.find('.ev-desc')[0];
  const q = new Quill(editorDiv, {theme: 'snow', modules:{toolbar: [['bold','italic'],['link']]}});
  if(eventObj?.desc) q.root.innerHTML = eventObj.desc;

  tr.find('.remove-event').on('click', ()=> tr.remove());
}

function gatherEvents(){
  const rows = $('#eventsTable tbody tr');
  const arr = [];
  rows.each(function(){
    const r = $(this);
    const name = r.find('.event-name').val();
    const short = r.find('.event-short').val();
    const date = r.find('.event-date').val();
    const start = r.find('.start-time').val();
    const end = r.find('.end-time').val();
    const desc = r.find('.ev-desc .ql-editor').html();
    arr.push({name, short, date, start, end, desc});
  });
  return arr;
}

function handleBannerPreview(input){
  const file = input.files && input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    $('#bannerPreview').attr('src', e.target.result).removeClass('d-none');
  };
  reader.readAsDataURL(file);
}

function handleSupportPreview(input){
  $('#supportPreview').empty();
  const files = input.files || [];
  Array.from(files).forEach(f=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = $(`<img class="support-thumb rounded me-1" src="${e.target.result}">`);
      $('#supportPreview').append(img);
    };
    reader.readAsDataURL(f);
  });
}

function saveWebinar(){
  const id = $('#editingId').val() || 'w_'+Date.now();
  const obj = {
    id,
    title: $('#title').val(),
    shortDesc: $('#shortDesc').val(),
    category: $('#category').val(),
    hostName: $('#hostName').val(),
    hostEmail: $('#hostEmail').val(),
    hostPhone: $('#countryCode').val() + ' ' + $('#hostPhone').val(),
    desc: quill.root.innerHTML,
    events: gatherEvents(),
    isActive: true,
    attainers: Math.floor(Math.random()*100), // placeholder
    createdAt: $('#editingId').val()? webinars.find(w=>w.id===id)?.createdAt: (new Date()).toISOString(),
  };

  // process images: convert File inputs to dataURLs and store in object (for demo only)
  const bannerFile = $('#bannerImage')[0].files[0];
  const supportFiles = $('#supportImages')[0].files;

  const finishSave = (bannerData, supportData)=>{
    obj.banner = bannerData || '';
    obj.supporting = supportData || [];

    const idx = webinars.findIndex(w=> w.id===id);
    if(idx>=0) webinars[idx] = obj; else webinars.unshift(obj);
    saveToStorage(); renderTable(); renderStats();
    bootstrap.Modal.getInstance(document.getElementById('webinarModal')).hide();
  };

  // read files async
  if(bannerFile || supportFiles.length){
    const promises = [];
    if(bannerFile){
      promises.push(new Promise(res=>{ const r=new FileReader(); r.onload=e=>res({banner:e.target.result}); r.readAsDataURL(bannerFile)}));
    } else promises.push(Promise.resolve({}));

    if(supportFiles.length){
      const ps = Array.from(supportFiles).map(f=> new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f)}));
      promises.push(Promise.all(ps));
    } else promises.push(Promise.resolve([]));

    Promise.all(promises).then(results=>{
      const bannerData = results[0].banner || '';
      const supportData = results[1] || [];
      finishSave(bannerData, supportData);
    });
  } else {
    finishSave('', []);
  }
}

function openSummary(id){
  const w = webinars.find(x=> x.id===id);
  if(!w) return;
  // populate summary
  $('#summaryTitle').text(w.title);
  $('#summaryShort').text(w.shortDesc || '');
  if(w.banner){
    $('#summaryBannerWrap').html(`<img src="${w.banner}" class="banner-preview">`);
  } else $('#summaryBannerWrap').empty();

  // youtube
  if(w.youtubeEmbed || w.youtubeLink){ }
  const ytId = extractYouTubeID(w.youtubeLink || '');
  if(ytId){
    $('#ytWrap').html(`<iframe width="100%" height="240" src="https://www.youtube.com/embed/${ytId}?rel=0&autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`);
  } else $('#ytWrap').empty();

  // supporting images carousel
  if((w.supporting||[]).length){
    let inner = '<div id="supportCarousel" class="carousel slide" data-bs-ride="carousel"><div class="carousel-inner">';
    w.supporting.forEach((s,i)=> inner += `<div class="carousel-item ${i===0? 'active':''}"><img src="${s}" class="d-block w-100" style="height:240px; object-fit:cover"></div>`);
    inner += `</div><button class="carousel-control-prev" type="button" data-bs-target="#supportCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button><button class="carousel-control-next" type="button" data-bs-target="#supportCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button></div>`;
    $('#supportingCarouselWrap').html(inner);
  } else $('#supportingCarouselWrap').empty();

  $('#summaryDesc').html(w.desc || '');

  const eventsWrap = $('#eventsCards'); eventsWrap.empty();
  (w.events||[]).forEach(ev=>{
    const card = $(`<div class="col-md-4"><div class="card"><div class="card-body"><h6>${ev.name}</h6><div class="text-muted small">${ev.date} ${ev.start} - ${ev.end}</div><div class="mt-2">${ev.desc}</div></div></div></div>`);
    eventsWrap.append(card);
  });

  // show summary
  $('#summaryView').show();
  $('html,body').animate({scrollTop: $('#summaryView').offset().top}, 300);
  // hide list
  // (we keep list visible; you can hide elements if you want full page)

  // edit button
  $('#editFromSummary').off('click').on('click', ()=> openEdit(w.id));
}

function openEdit(id){
  const w = webinars.find(x=> x.id===id);
  if(!w) return;
  resetModal();
  $('#modalTitle').text('Edit Webinar');
  $('#editingId').val(w.id);
  $('#title').val(w.title);
  $('#shortDesc').val(w.shortDesc);
  $('#category').val(w.category||'online');
  $('#hostName').val(w.hostName);
  $('#hostEmail').val(w.hostEmail);
  if(w.hostPhone){ const parts = w.hostPhone.split(' '); $('#countryCode').val(parts[0]||'+91'); $('#hostPhone').val(parts.slice(1).join(' ')); }
  quill.root.innerHTML = w.desc || '';
  if(w.banner) { $('#bannerPreview').attr('src', w.banner).removeClass('d-none'); }
  if(w.supporting){ $('#supportPreview').empty(); w.supporting.forEach(s=> $('#supportPreview').append(`<img class="support-thumb rounded" src="${s}">`)); }
  (w.events||[]).forEach(ev=> addEventRow(ev));
  const modal = new bootstrap.Modal(document.getElementById('webinarModal'));
  modal.show();
}

function extractYouTubeID(url){
  if(!url) return null;
  const m = url.match(/[\?&]v=([^&]+)/) || url.match(/youtu\.be\/([^?&]+)/) || url.match(/embed\/([^?&]+)/);
  return m? m[1]: null;
}

$(function(){
  quill = new Quill('#descEditor', {theme:'snow'});

  loadFromStorage(); renderTable(); renderStats();

  $('#btnAdd').on('click', openAddModal);
  $('#addEventRow').on('click', ()=> addEventRow());
  $('#bannerImage').on('change', function(){ handleBannerPreview(this); });
  $('#supportImages').on('change', function(){ handleSupportPreview(this); });

  $('#cancelBtn').on('click', ()=> $('#confirmCancelModal').modal('show'));
  $('#confirmCancelYes').on('click', ()=> { bootstrap.Modal.getInstance(document.getElementById('webinarModal')).hide(); });

  $('#saveBtn').on('click', ()=> saveWebinar());

  $('#backToList').on('click', ()=>{ $('#summaryView').hide(); });

  // quick sample data loader if none
  if(webinars.length===0){
    webinars.push({id:'sample1', title:'Intro to UI/UX', shortDesc:'Design basics', events:[{name:'Session 1', short:'Basics', desc:'<p>Intro</p>', date:'2025-10-20', start:'10:30 AM', end:'12:30 PM'}], isActive:true, attainers:23, createdAt: new Date().toISOString(), banner:'', supporting:[]});
    saveToStorage(); renderTable(); renderStats();
  }

});
</script>
</body>
</html>
